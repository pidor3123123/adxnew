# Руководство по проверке системы мониторинга соединений БД

## Полное руководство от А до Я

### Подготовка

1. **Откройте сайт** в браузере (например, `https://adx.finance` или локально)
2. **Откройте консоль разработчика** (F12 или Ctrl+Shift+I)
3. **Перейдите на вкладку Console** в инструментах разработчика
4. **Перейдите на вкладку Network** (для отслеживания запросов)

---

## Часть 1: Проверка API endpoint (health.php)

### Шаг 1.1: Прямая проверка через браузер

1. Откройте новую вкладку в браузере
2. Введите URL: `https://adx.finance/api/health.php` (или ваш домен)
3. Нажмите Enter

**Ожидаемый результат:**
```json
{
  "mysql": true,
  "supabase": true,
  "timestamp": "2025-01-30 21:44:37"
}
```

**Если видите ошибку:**
- `404 Not Found` - файл `api/health.php` не загружен на сервер
- `500 Internal Server Error` - проблема с подключением к БД (проверьте логи сервера)
- `CORS error` - проблема с настройками CORS

### Шаг 1.2: Проверка через консоль браузера

1. На любой странице сайта откройте консоль (F12)
2. Выполните команду:
```javascript
fetch('/api/health.php?_t=' + Date.now())
  .then(r => r.json())
  .then(data => console.log('Health check:', data))
  .catch(err => console.error('Error:', err));
```

`
**Ожидаемый результат в консоли:**
```
Health check: {mysql: true, supabase: true, timestamp: "2025-01-30 21:44:37"}
```

### Шаг 1.3: Проверка через Network tab

1. Откройте вкладку **Network** в инструментах разработчика
2. Обновите страницу (F5)
3. Найдите запрос к `health.php` в списке запросов
4. Кликните на запрос
5. Перейдите на вкладку **Response**

**Ожидаемый результат:**
- Статус: `200 OK`
- Response содержит JSON с `mysql: true` и `supabase: true`

---

## Часть 2: Проверка работы мониторинга в браузере

### Шаг 2.1: Проверка инициализации

1. Откройте любую страницу сайта (например, `index.html` или `trade.html`)
2. Откройте консоль (F12)
3. Выполните команду:
```javascript
DBMonitor.getStatus()
```

**Ожидаемый результат:**
```javascript
{
  mysql: true,        // или false
  supabase: true,     // или false
  timestamp: "2025-01-30T21:44:37.000Z",
  responseTime: 45    // время ответа в миллисекундах
}
```

### Шаг 2.2: Проверка автоматического запуска

1. Откройте консоль (F12)
2. Подождите 30 секунд
3. Проверьте логи в консоли

**Ожидаемые сообщения в консоли:**
```
[2025-01-30T21:44:37.000Z] [INFO] Starting database connection monitoring {interval: "30000ms"}
[2025-01-30T21:44:37.000Z] [INFO] Database connection status changed {mysql: true, supabase: true, ...}
```

**Если сообщений нет:**
- Проверьте, что `js/db-monitor.js` загружен (вкладка Network)
- Проверьте, нет ли ошибок JavaScript в консоли

### Шаг 2.3: Проверка периодических проверок

1. Откройте консоль (F12)
2. Подождите 1-2 минуты
3. Проверьте, что каждые 30 секунд появляются логи о проверке соединений

**Ожидаемые сообщения:**
```
[2025-01-30T21:45:07.000Z] [INFO] Database connection status changed {mysql: true, supabase: true, ...}
[2025-01-30T21:45:37.000Z] [INFO] Database connection status changed {mysql: true, supabase: true, ...}
```

### Шаг 2.4: Проверка сохранения статуса в localStorage

1. Откройте консоль (F12)
2. Выполните команду:
```javascript
JSON.parse(localStorage.getItem('db_monitor_status'))
```

**Ожидаемый результат:**
```javascript
{
  mysql: true,
  supabase: true,
  timestamp: "2025-01-30 21:44:37",
  responseTime: 45,
  lastCheck: 1735592677000  // timestamp в миллисекундах
}
```

3. Обновите страницу (F5)
4. Снова выполните команду - статус должен сохраниться

---

## Часть 3: Проверка логирования

### Шаг 3.1: Проверка логов в Logger

1. Откройте консоль (F12)
2. Выполните команду:
```javascript
Logger.getLogs()
```

**Ожидаемый результат:**
Массив строк с логами, включая записи о мониторинге БД:
```
[
  "[2025-01-30T21:44:37.000Z] [SYSTEM] Logger initialized",
  "[2025-01-30T21:44:37.000Z] [INFO] Starting database connection monitoring {interval: \"30000ms\"}",
  "[2025-01-30T21:44:37.000Z] [INFO] Database connection status changed {mysql: true, supabase: true, ...}",
  ...
]
```

### Шаг 3.2: Проверка экспорта логов

1. Откройте консоль (F12)
2. Выполните команду:
```javascript
console.log(Logger.exportLogs())
```

**Ожидаемый результат:**
Текстовый вывод всех логов, разделенных переносами строк

### Шаг 3.3: Фильтрация логов по типу

1. Откройте консоль (F12)
2. Выполните команду:
```javascript
Logger.getLogs().filter(log => log.includes('Database connection'))
```

**Ожидаемый результат:**
Только логи, связанные с мониторингом БД

---

## Часть 4: Проверка автоматического восстановления

### Шаг 4.1: Симуляция обрыва соединения (отключение интернета)

1. Откройте консоль (F12)
2. Отключите интернет (отключите Wi-Fi или сетевой кабель)
3. Подождите 30-60 секунд

**Ожидаемые сообщения в консоли:**
```
[2025-01-30T21:45:37.000Z] [ERROR] Database health check failed {error: "Failed to fetch", name: "TypeError"}
[2025-01-30T21:45:37.000Z] [INFO] Attempting to recover database connection {attempt: 1, maxAttempts: 5, delay: "1000ms"}
[2025-01-30T21:45:38.000Z] [INFO] Attempting to recover database connection {attempt: 2, maxAttempts: 5, delay: "2000ms"}
...
```

4. Включите интернет обратно
5. Подождите несколько секунд

**Ожидаемые сообщения:**
```
[2025-01-30T21:46:10.000Z] [INFO] Database connections recovered {recoveryAttempts: 3}
[2025-01-30T21:46:10.000Z] [INFO] Database connection status changed {mysql: true, supabase: true, ...}
```

### Шаг 4.2: Симуляция обрыва через DevTools (Network throttling)

1. Откройте вкладку **Network** в инструментах разработчика
2. Найдите выпадающий список **Throttling** (обычно вверху)
3. Выберите **Offline**
4. Подождите 30-60 секунд
5. Проверьте логи в консоли (должны появиться сообщения об ошибках)
6. Верните **Throttling** в **No throttling**
7. Подождите несколько секунд
8. Проверьте, что соединение восстановилось

### Шаг 4.3: Проверка экспоненциальной задержки

1. Откройте консоль (F12)
2. Отключите интернет
3. Отслеживайте время между попытками восстановления в логах

**Ожидаемые задержки:**
- Попытка 1: ~1 секунда
- Попытка 2: ~2 секунды
- Попытка 3: ~4 секунды
- Попытка 4: ~8 секунд
- Попытка 5: ~16 секунд (но не более 30 секунд)

### Шаг 4.4: Проверка ограничения попыток

1. Откройте консоль (F12)
2. Отключите интернет
3. Подождите, пока не будет сделано 5 попыток восстановления
4. Проверьте логи

**Ожидаемое сообщение:**
```
[2025-01-30T21:47:00.000Z] [ERROR] Max recovery attempts reached {attempts: 5}
```

После этого новые попытки восстановления не должны запускаться автоматически (только при следующей периодической проверке).

---

## Часть 5: Проверка работы при переключении вкладок

### Шаг 5.1: Проверка при возврате фокуса

1. Откройте сайт в браузере
2. Откройте консоль (F12)
3. Переключитесь на другую вкладку браузера (или другое приложение)
4. Подождите 1-2 минуты
5. Вернитесь на вкладку с сайтом
6. Проверьте консоль

**Ожидаемый результат:**
Сразу после возврата фокуса должна быть выполнена проверка соединений:
```
[2025-01-30T21:48:00.000Z] [INFO] Database connection status changed {mysql: true, supabase: true, ...}
```

### Шаг 5.2: Проверка при фокусе окна

1. Откройте сайт в браузере
2. Откройте консоль (F12)
3. Сверните окно браузера или переключитесь на другое приложение
4. Подождите 1-2 минуты
5. Верните фокус на окно браузера
6. Проверьте консоль

**Ожидаемый результат:**
Сразу после возврата фокуса должна быть выполнена проверка соединений

---

## Часть 6: Проверка статуса в реальном времени

### Шаг 6.1: Мониторинг статуса в консоли

1. Откройте консоль (F12)
2. Выполните команду для постоянного мониторинга:
```javascript
setInterval(() => {
  const status = DBMonitor.getStatus();
  console.log('Current DB status:', status);
}, 5000); // Каждые 5 секунд
```

**Ожидаемый результат:**
Каждые 5 секунд в консоли появляется текущий статус соединений

### Шаг 6.2: Проверка через Network tab

1. Откройте вкладку **Network** в инструментах разработчика
2. Обновите страницу (F5)
3. Найдите запросы к `health.php`
4. Проверьте, что запросы выполняются каждые 30 секунд

**Как проверить:**
- Отсортируйте запросы по времени
- Найдите запросы к `health.php`
- Проверьте интервал между запросами (должен быть ~30 секунд)

---

## Часть 7: Проверка при различных сценариях

### Сценарий 1: Медленное соединение

1. Откройте вкладку **Network** в инструментах разработчика
2. Установите **Throttling** на **Slow 3G**
3. Откройте консоль (F12)
4. Подождите 1-2 минуты
5. Проверьте, что мониторинг продолжает работать (может быть задержка, но запросы должны выполняться)

### Сценарий 2: Временный обрыв и восстановление

1. Откройте консоль (F12)
2. Отключите интернет на 10 секунд
3. Включите интернет обратно
4. Проверьте логи - должно быть автоматическое восстановление

### Сценарий 3: Долгий обрыв

1. Откройте консоль (F12)
2. Отключите интернет на 5 минут
3. Включите интернет обратно
4. Проверьте логи - должны быть все 5 попыток восстановления, затем автоматическая проверка при следующем цикле

---

## Часть 8: Проверка через API напрямую

### Шаг 8.1: Проверка через curl (если есть доступ к серверу)

```bash
curl https://adx.finance/api/health.php
```

**Ожидаемый результат:**
```json
{"mysql":true,"supabase":true,"timestamp":"2025-01-30 21:44:37"}
```

### Шаг 8.2: Проверка через PowerShell (Windows)

```powershell
Invoke-WebRequest -Uri "https://adx.finance/api/health.php" | Select-Object -ExpandProperty Content
```

---

## Часть 9: Проверка логов на сервере

### Шаг 9.1: Проверка PHP логов

Если у вас есть доступ к серверу, проверьте логи PHP:

```bash
tail -f /var/log/php_errors.log
# или
tail -f /var/log/apache2/error.log
```

**Ожидаемые записи:**
- При успешной проверке: нет ошибок
- При ошибке MySQL: `MySQL health check failed: ...`
- При ошибке Supabase: `Supabase health check failed: ...`

---

## Часть 10: Визуальная проверка в браузере

### Шаг 10.1: Проверка через Application/Storage tab

1. Откройте инструменты разработчика (F12)
2. Перейдите на вкладку **Application** (Chrome) или **Storage** (Firefox)
3. В левой панели найдите **Local Storage**
4. Выберите ваш домен
5. Найдите ключ `db_monitor_status`

**Ожидаемый результат:**
Значение должно содержать JSON с текущим статусом соединений

### Шаг 10.2: Проверка через Console с визуализацией

1. Откройте консоль (F12)
2. Выполните команду для красивого вывода:
```javascript
const status = DBMonitor.getStatus();
console.table({
  MySQL: status.mysql ? '✅ Connected' : '❌ Disconnected',
  Supabase: status.supabase ? '✅ Connected' : '❌ Disconnected',
  'Last Check': status.timestamp,
  'Response Time': status.responseTime ? status.responseTime + 'ms' : 'N/A'
});
```

---

## Часть 11: Проверка производительности

### Шаг 11.1: Проверка времени ответа

1. Откройте вкладку **Network** в инструментах разработчика
2. Найдите запрос к `health.php`
3. Проверьте время выполнения (Time column)

**Ожидаемый результат:**
- Обычно: 50-200ms
- При медленном соединении: до 1000ms
- При таймауте: 5000ms (запрос прервется)

### Шаг 11.2: Проверка нагрузки на сервер

1. Откройте консоль (F12)
2. Выполните команду для подсчета запросов:
```javascript
let requestCount = 0;
const originalFetch = window.fetch;
window.fetch = function(...args) {
  if (args[0].includes('health.php')) {
    requestCount++;
    console.log(`Health check request #${requestCount}`);
  }
  return originalFetch.apply(this, args);
};
```

Подождите 2 минуты и проверьте количество запросов (должно быть ~4 запроса за 2 минуты при интервале 30 секунд)

---

## Часть 12: Проверка обработки ошибок

### Шаг 12.1: Симуляция ошибки MySQL

Если у вас есть доступ к серверу, временно измените настройки подключения к MySQL в `config/database.php` (неправильный пароль) и проверьте:

1. Откройте консоль (F12)
2. Подождите 30 секунд
3. Проверьте логи

**Ожидаемый результат:**
```
[2025-01-30T21:50:00.000Z] [WARN] Database connection issue detected {mysql: false, supabase: true, ...}
[2025-01-30T21:50:00.000Z] [INFO] Attempting to recover database connection {attempt: 1, ...}
```

### Шаг 12.2: Симуляция ошибки Supabase

Аналогично, временно измените настройки Supabase и проверьте обработку ошибки

---

## Часть 13: Финальная проверка - полный цикл

### Полный тест:

1. **Откройте сайт** и консоль (F12)
2. **Проверьте инициализацию:**
   ```javascript
   DBMonitor.getStatus()
   ```
3. **Подождите 1 минуту** и проверьте логи
4. **Отключите интернет** на 30 секунд
5. **Проверьте логи** об ошибках и попытках восстановления
6. **Включите интернет**
7. **Проверьте логи** об успешном восстановлении
8. **Переключитесь на другую вкладку** на 1 минуту
9. **Вернитесь** и проверьте, что мониторинг продолжил работу
10. **Проверьте localStorage:**
    ```javascript
    JSON.parse(localStorage.getItem('db_monitor_status'))
    ```
11. **Проверьте все логи:**
    ```javascript
    Logger.getLogs().filter(log => log.includes('Database'))
    ```

---

## Часть 14: Устранение проблем

### Проблема: Мониторинг не запускается

**Решение:**
1. Проверьте, что `js/db-monitor.js` загружен (Network tab)
2. Проверьте консоль на наличие ошибок JavaScript
3. Проверьте, что `js/logger.js` загружен перед `db-monitor.js`

### Проблема: Запросы к health.php возвращают 404

**Решение:**
1. Проверьте, что файл `api/health.php` загружен на сервер
2. Проверьте правильность пути в `js/db-monitor.js` (должно быть `/api/health.php`)

### Проблема: Запросы к health.php возвращают 500

**Решение:**
1. Проверьте логи сервера
2. Проверьте, что `config/database.php` и `config/supabase.php` загружаются корректно
3. Проверьте настройки подключения к БД

### Проблема: Мониторинг не восстанавливает соединение

**Решение:**
1. Проверьте, что интернет действительно восстановлен
2. Проверьте логи - возможно, достигнут лимит попыток
3. Обновите страницу для сброса счетчика попыток

---

## Быстрая проверка (чек-лист)

- [ ] API endpoint `/api/health.php` возвращает JSON с `mysql` и `supabase`
- [ ] В консоли появляются логи о запуске мониторинга
- [ ] Каждые 30 секунд выполняются проверки соединений
- [ ] Статус сохраняется в `localStorage` под ключом `db_monitor_status`
- [ ] При обрыве интернета запускается автоматическое восстановление
- [ ] При восстановлении интернета соединения восстанавливаются автоматически
- [ ] При возврате фокуса на вкладку выполняется проверка соединений
- [ ] Все события логируются в `Logger`
- [ ] Экспоненциальная задержка между попытками работает корректно
- [ ] Максимум 5 попыток восстановления соблюдается

---

## Дополнительные команды для отладки

### Остановить мониторинг:
```javascript
DBMonitor.stopMonitoring()
```

### Запустить мониторинг вручную:
```javascript
DBMonitor.startMonitoring()
```

### Выполнить проверку вручную:
```javascript
DBMonitor.checkConnections()
```

### Очистить сохраненный статус:
```javascript
localStorage.removeItem('db_monitor_status')
```

### Просмотреть все логи мониторинга:
```javascript
Logger.getLogs().filter(log => log.includes('Database') || log.includes('DBMonitor'))
```

---

## Заключение

Если все проверки пройдены успешно, система мониторинга работает корректно и будет автоматически отслеживать соединения с базами данных 24/7, восстанавливая их при обрыве.
