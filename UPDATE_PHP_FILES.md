# Инструкция по замене исправленных PHP файлов на Hostinger

## Исправленные файлы

Были исправлены следующие файлы для устранения ошибки 500 и обеспечения корректных JSON ответов:

1. **`api/auth.php`** - добавлена глобальная обработка ошибок, обернуты require_once в try-catch
2. **`config/database.php`** - заменен die() на выброс исключений для корректной обработки ошибок
3. **`api/sync.php`** - добавлена буферизация вывода для предотвращения попадания предупреждений в JSON

## Где находятся файлы на Hostinger

На сервере Hostinger эти файлы находятся по пути:
```
public_html/api/auth.php
public_html/config/database.php
public_html/api/sync.php
```

## Способ 1: Замена через ZIP архив (Рекомендуется)

Если вы еще не загружали файлы на Hostinger или хотите обновить все:

1. Загрузите обновленный файл `adx-finance-hostinger.zip` на Hostinger
2. Распакуйте его в `public_html/`
3. Все файлы будут автоматически заменены

## Способ 2: Замена отдельных файлов через File Manager

Если нужно заменить только исправленные файлы:

1. Войдите в панель Hostinger (hPanel)
2. Перейдите в **"Файлы"** → **"File Manager"**
3. Откройте папку `public_html/api/` и `public_html/config/`
4. Загрузите новые версии файлов:
   - `api/auth.php` → замените существующий файл
   - `config/database.php` → замените существующий файл
   - `api/sync.php` → замените существующий файл

**Откуда брать файлы:**
- Из папки `hostinger-deploy/api/` в вашем проекте
- Или из распакованного `adx-finance-hostinger.zip`

## Способ 3: Замена через FTP

Если используете FTP клиент (FileZilla, WinSCP и т.д.):

1. Подключитесь к серверу Hostinger по FTP
2. Перейдите в папки `/public_html/api/` и `/public_html/config/`
3. Загрузите файлы:
   - `hostinger-deploy/api/auth.php` → `/public_html/api/auth.php`
   - `hostinger-deploy/config/database.php` → `/public_html/config/database.php`
   - `hostinger-deploy/api/sync.php` → `/public_html/api/sync.php`
4. Замените существующие файлы

## Проверка после замены

После замены файлов:

1. Откройте `https://adx.finance/register.html`
2. Попробуйте зарегистрироваться
3. Ошибки "Unexpected end of JSON input" и "500 Internal Server Error" должны исчезнуть
4. Если есть ошибки, они теперь будут отображаться в понятном JSON формате

## Важно

- Убедитесь, что права доступа на файлы установлены правильно (644 для файлов)
- После замены проверьте, что сайт работает корректно
- Если используете кеш, очистите его

## Что было исправлено

### `api/auth.php`:
- ✅ Добавлена глобальная обработка ошибок (`set_error_handler()`) для перехвата всех PHP ошибок
- ✅ Добавлена обработка фатальных ошибок (`register_shutdown_function()`)
- ✅ Обернуты все `require_once` в try-catch блоки для безопасной загрузки файлов
- ✅ Улучшена буферизация вывода для предотвращения попадания предупреждений в JSON

### `config/database.php`:
- ✅ Заменен `die(json_encode(...))` на выброс исключения `PDOException`
- ✅ Это позволяет `auth.php` перехватить ошибку и вернуть корректный JSON с правильными заголовками

### `api/sync.php`:
- ✅ Добавлена буферизация вывода (`ob_start()`) в начале файла
- ✅ Добавлен `ob_end_clean()` перед каждым `echo json_encode()`
- ✅ Добавлен `exit` после каждого `echo json_encode()`

Эти исправления гарантируют, что:
- Все ошибки (включая фатальные PHP ошибки) будут возвращать валидный JSON
- Ошибка 500 будет содержать понятное сообщение об ошибке в JSON формате
- JSON ответы будут чистыми, без лишних символов или PHP предупреждений
