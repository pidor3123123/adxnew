# Инструкция по настройке синхронизации

## Текущая конфигурация

### Supabase
- **URL**: `https://teqnsfxvogniblyvsfun.supabase.co`
- **Service Role Key**: `sb_secret_1n5HZHAYXSXLg5wnanntrA_d_t82MzG` (уже настроен в `config/supabase.php`)

### Webhook URL

**Важно**: Webhook URL - это адрес вашего основного сайта, где находится файл `api/webhook.php`.

#### Если сайт работает локально (OSPanel):
```
http://monterramarket2.local/api/webhook.php
```

#### Если сайт будет на хостинге:
```
https://ваш-домен.com/api/webhook.php
```

## Настройка админ панели

В файле `.env` админ панели (`C:\Users\agyzo\admin-dashboard\.env`) добавьте:

```env
# Supabase (уже должно быть настроено)
NEXT_PUBLIC_SUPABASE_URL=https://teqnsfxvogniblyvsfun.supabase.co
SUPABASE_SERVICE_ROLE_KEY=sb_secret_1n5HZHAYXSXLg5wnanntrA_d_t82MzG

# Webhook для отправки изменений на основной сайт
WEBHOOK_URL=http://monterramarket2.local/api/webhook.php
WEBHOOK_SECRET=novatrade-webhook-secret-2024
```

**Важно**: `WEBHOOK_SECRET` должен совпадать на обоих сайтах (основном и админ панели).

## Первый запуск

### 1. Синхронизация существующих пользователей

Запустите скрипт массовой синхронизации:

```bash
php sync_to_supabase.php --all
```

Или по отдельности:
```bash
php sync_to_supabase.php --users      # Только пользователи
php sync_to_supabase.php --balances   # Только балансы
```

### 2. Проверка синхронизации

1. Зарегистрируйте нового пользователя на основном сайте
2. Проверьте в админ панели - пользователь должен появиться автоматически
3. Измените баланс пользователя в админ панели
4. Проверьте на основном сайте - баланс должен обновиться

## Как это работает

### Синхронизация из основного сайта в Supabase:
1. Пользователь регистрируется → автоматически создается в Supabase
2. Изменяется баланс → автоматически синхронизируется с Supabase
3. Создается ордер → можно синхронизировать (опционально)

### Синхронизация из админ панели в основной сайт:
1. Админ блокирует пользователя → отправляется webhook → обновляется `is_active` в MySQL
2. Админ изменяет баланс → отправляется webhook → обновляется баланс в MySQL
3. Админ обновляет данные пользователя → отправляется webhook → обновляются данные в MySQL

## Устранение проблем

### Webhook не работает

1. **Проверьте URL**: Убедитесь, что `WEBHOOK_URL` доступен из админ панели
   - Если админ панель на другом сервере, используйте публичный URL
   - Если локально, убедитесь, что оба сайта в одной сети

2. **Проверьте секрет**: `WEBHOOK_SECRET` должен совпадать на обоих сайтах

3. **Проверьте логи**: Смотрите ошибки в консоли админ панели и логах PHP

### Пользователи не синхронизируются

1. Проверьте `SUPABASE_SERVICE_ROLE_KEY` в `config/supabase.php`
2. Проверьте подключение к Supabase (должен быть доступен из PHP)
3. Запустите скрипт синхронизации вручную: `php sync_to_supabase.php --users`

### Балансы не синхронизируются

1. Убедитесь, что таблица `user_balances` существует в Supabase
2. Проверьте структуру таблицы (должны быть поля: `user_id`, `currency`, `available_balance`, `locked_balance`)
3. Запустите скрипт синхронизации: `php sync_to_supabase.php --balances`

## Безопасность

⚠️ **Важно**: 
- `SUPABASE_SERVICE_ROLE_KEY` - это секретный ключ, не публикуйте его в репозитории
- `WEBHOOK_SECRET` - должен быть сложным и уникальным
- Используйте HTTPS для production окружения

## Деплой на хостинг

Когда будете деплоить на хостинг:

1. Обновите `WEBHOOK_URL` в админ панели на публичный URL
2. Убедитесь, что `api/webhook.php` доступен публично
3. Настройте переменные окружения на хостинге (если используете)
